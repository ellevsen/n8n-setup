# Traefik - reverse proxy e TLS (vari√°veis: LETSENCRYPT_EMAIL, DOMAIN_TRAEFIK_DASHBOARD)
services:
  traefik:
    image: traefik:latest
    command:
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--ping=true"
      - "--providers.swarm=true"
      - "--providers.swarm.endpoint=unix:///var/run/docker.sock"
      - "--providers.swarm.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencryptresolver.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.letsencryptresolver.acme.storage=/etc/traefik/acme/acme.json"
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--providers.file.filename=/etc/traefik/dynamic/dynamic.yml"
      - "--providers.file.watch=true"
    configs:
      - source: traefik_global_middlewares
        target: /etc/traefik/dynamic/dynamic.yml
    volumes:
      - vol_certificates:/etc/traefik/acme
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - vol_traefik_logs:/var/log/traefik
    networks:
      - main
    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 15s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 256M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
      labels:
        - "traefik.enable=true"
        - "traefik.swarm.network=main"
        - "traefik.http.routers.traefik.rule=Host(`${DOMAIN_TRAEFIK_DASHBOARD}`)"
        - "traefik.http.routers.traefik.entrypoints=websecure"
        - "traefik.http.routers.traefik.tls=true"
        - "traefik.http.routers.traefik.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.traefik.service=api@internal"
        - "traefik.http.services.traefik.loadbalancer.server.port=8080"
        - "traefik.http.routers.traefik.middlewares=security-headers@file,rate-limit@file"

networks:
  main:
    external: true

configs:
  traefik_global_middlewares:
    external: true
    name: traefik_global_middlewares

volumes:
  vol_certificates:
    external: true
  vol_traefik_logs:
